<p-dialog
    [(visible)]="visible"
    [modal]="true"
    [closable]="false"
    [draggable]="false"
    [resizable]="false"
    [dismissableMask]="true"
    styleClass="!rounded-[3rem] !border-none !shadow-2xl !bg-slate-50 dark:!bg-slate-950 overflow-hidden"
    [style]="{ width: '90vw', maxWidth: '1200px' }"
>
    <ng-template pTemplate="header">
        <div class="flex justify-between items-center w-full pt-4 px-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-2xl flex items-center justify-center">
                    <i class="pi pi-search text-2xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-black text-slate-800 dark:text-slate-100 uppercase tracking-tighter">Búsqueda Global</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Encuentra productos por nombre, EAN o categoría</p>
                </div>
            </div>
            <button (click)="visible = false" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:bg-rose-50 hover:text-rose-500 transition-all">
                <i class="pi pi-times text-xl"></i>
            </button>
        </div>
    </ng-template>

    <div class="flex flex-col h-[70vh]">
        <div class="p-6 sticky top-0 z-10 bg-slate-50/80 dark:bg-slate-950/80 backdrop-blur-md">
            <div class="relative group">
                <i class="pi pi-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-emerald-500 transition-colors"></i>
                <input
                    #searchInputRef
                    pInputText
                    [(ngModel)]="searchTerm"
                    (keydown)="handleKeyboardNavigation($event)"
                    placeholder="Escribe el nombre del producto o escanea código de barras..."
                    class="w-full !pl-14 !rounded-[1.5rem] !border-none !bg-white dark:!bg-slate-900 !py-5 !text-lg !shadow-xl !shadow-slate-200/50 dark:!shadow-none focus:!ring-2 focus:!ring-emerald-500 dark:text-white transition-all"
                />
                <div class="absolute right-4 top-1/2 -translate-y-1/2 hidden md:flex items-center gap-2">
                    <span class="px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-[10px] font-black text-slate-400">ESC para salir</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-6 custom-scrollbar">
            @if (filteredProducts.length === 0) {
                <div class="flex flex-col items-center justify-center py-20 opacity-30">
                    <i class="pi pi-box text-7xl mb-4"></i>
                    <p class="text-xl font-black uppercase tracking-[0.2em]">Sin coincidencias</p>
                </div>
            } @else {
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
                    @for (product of filteredProducts; track product.id) {
                        <button
                            (click)="handleSelectProduct(product)"
                            [class]="selectedIndex === $index ? 'ring-2 ring-emerald-500 bg-emerald-50/50 dark:bg-emerald-900/10 scale-[1.02]' : 'bg-white dark:bg-slate-900 border-slate-200/60 dark:border-slate-800'"
                            class="group relative text-left flex flex-col p-5 border rounded-[2rem] transition-all duration-200 hover:shadow-xl shadow-slate-200/60 dark:shadow-none overflow-hidden"
                        >
                            <div [class]="product.stock > 0 ? 'bg-emerald-500' : 'bg-rose-500'" class="absolute top-0 right-8 px-3 py-1 rounded-b-xl text-[9px] font-black text-white uppercase tracking-tighter">Stock: {{ product.stock }}</div>

                            <div class="flex items-start gap-4 mb-4">
                                <div class="w-14 h-14 shrink-0 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center border border-slate-200 dark:border-slate-700">
                                    <i class="pi pi-image text-slate-400 text-xl"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <h3 class="font-black text-slate-800 dark:text-slate-100 text-base leading-tight truncate uppercase tracking-tighter">
                                        {{ product.name }}
                                    </h3>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Ref: {{ product.reference || 'N/A' }}</p>
                                </div>
                            </div>

                            <div class="mt-auto flex justify-between items-end">
                                <div class="flex flex-col">
                                    <span class="text-[9px] font-black text-emerald-600 dark:text-emerald-400 uppercase tracking-widest">Precio Venta</span>
                                    <span class="text-2xl font-black text-slate-800 dark:text-slate-100 tracking-tighter">
                                        {{ product.price | currency: currencyCode : 'symbol' : '1.0-0' : locale }}
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="block text-[9px] font-mono text-slate-400">{{ product.barcode }}</span>
                                    @if (product.hasDiscount) {
                                        <span class="inline-block bg-rose-500 text-white text-[9px] font-black px-2 py-0.5 rounded mt-1">-{{ product.discountPercent }}%</span>
                                    }
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                                <span class="px-3 py-1 bg-slate-100 dark:bg-slate-800 text-[9px] font-black text-slate-500 uppercase rounded-lg italic">
                                    {{ product.category }}
                                </span>
                                @if (product.extension1) {
                                    <span class="px-3 py-1 border border-dashed border-slate-300 dark:border-slate-700 text-[9px] font-bold text-slate-400 uppercase rounded-lg">
                                        {{ product.extension1 }}
                                    </span>
                                }
                            </div>
                        </button>
                    }
                </div>
            }
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-between items-center px-8 py-6 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest">{{ filteredProducts.length }} Coincidencias encontradas</p>
            </div>
            <div class="flex gap-3">
                <button (click)="visible = false" class="px-6 py-3 text-xs font-black text-slate-400 uppercase tracking-widest hover:text-slate-600 transition-colors">Cancelar</button>
                <button class="px-8 py-3 bg-slate-800 dark:bg-emerald-600 text-white text-xs font-black uppercase tracking-widest rounded-xl shadow-lg shadow-slate-200 dark:shadow-none">Seleccionar Producto</button>
            </div>
        </div>
    </ng-template>
</p-dialog>
