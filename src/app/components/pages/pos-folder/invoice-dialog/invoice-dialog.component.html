<p-dialog
    [(visible)]="visible"
    (visibleChange)="visibleChange.emit($event)"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="!rounded-[2rem] !border-none !shadow-2xl !bg-white dark:!bg-slate-950 overflow-hidden print:!p-0 print:!shadow-none print:!w-full print:!max-h-full"
    [style]="{ width: '90vw', maxWidth: '800px' }"
>
    <ng-template pTemplate="header">
        <div class="flex items-center justify-between w-full pr-6 print:hidden">
            <div>
                <h2 class="text-xl font-black text-slate-800 dark:text-slate-100 uppercase tracking-tighter">Vista Previa de Factura</h2>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Revisa los detalles antes de imprimir</p>
            </div>
            <div class="flex gap-2">
                <button (click)="handlePrint()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-emerald-500 hover:text-white text-slate-600 rounded-xl transition-all font-bold text-xs uppercase tracking-widest">
                    <i class="pi pi-print"></i> Imprimir
                </button>
                <button (click)="handleDownload()" class="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white hover:bg-slate-800 rounded-xl transition-all font-bold text-xs uppercase tracking-widest shadow-lg shadow-slate-200">
                    <i class="pi pi-download"></i> PDF
                </button>
            </div>
        </div>
    </ng-template>

    <div class="flex-1 px-10 py-8 overflow-y-auto print:overflow-visible bg-white dark:bg-slate-950" id="invoice-container">
        <div class="space-y-8">
            <section class="flex justify-between items-start border-b-4 border-slate-900 dark:border-emerald-500 pb-8">
                <div class="space-y-1">
                    <h1 class="text-4xl font-black text-slate-900 dark:text-white tracking-tighter uppercase leading-none">{{ selectedCompany.compania }}</h1>
                    <div class="flex flex-col text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                        <span>{{ selectedCompany.location }}</span>
                        <!--  <span>Medellín, Antioquia, 050021</span> -->
                        <span>NIT: {{ selectedCompany.nit }}-{{ selectedCompany.dv }}</span>
                        <span class="text-slate-900 dark:text-emerald-400" *ngIf="selectedCompany.phone != ''">Tel: {{ selectedCompany.phone }}</span>
                    </div>
                </div>

                <div class="text-right">
                    <div class="bg-slate-900 dark:bg-emerald-600 text-white px-6 py-2 rounded-full inline-block mb-3">
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Factura N°</span>
                        <span class="text-xl font-black ml-2 tracking-tighter">{{ invoiceNumber }}</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center justify-end gap-2"><i class="pi pi-calendar text-emerald-500"></i> {{ date | date: 'longDate' : '' : 'es-CO' }}</p>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ date | date: 'shortTime' : '' : 'es-CO' }}</p>
                    </div>
                </div>
            </section>

            <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                @if (customer) {
                    <div class="p-6 bg-slate-50 dark:bg-slate-900 rounded-[1.5rem] border border-slate-100 dark:border-slate-800">
                        <h3 class="text-[10px] font-black text-emerald-600 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="pi pi-user"></i> Datos del Cliente</h3>
                        <div class="space-y-1 text-sm">
                            <p class="font-black text-slate-800 dark:text-white uppercase tracking-tighter text-base">{{ getFullName(customer) }}</p>
                            <p class="text-slate-500 font-medium">NIT/CC: {{ customer.document }}</p>
                            <p class="text-slate-500 font-medium">{{ customer.email }}</p>
                            <p class="text-slate-500 font-medium">{{ customer.phone }}</p>
                        </div>
                    </div>
                }

                @if (deliveryInfo?.isDelivery) {
                    <div class="p-6 bg-emerald-50/50 dark:bg-emerald-950/20 rounded-[1.5rem] border border-emerald-100 dark:border-emerald-900/50">
                        <h3 class="text-[10px] font-black text-emerald-600 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="pi pi-map-marker"></i> Logística de Entrega</h3>
                        <div class="space-y-1 text-sm font-medium text-slate-600 dark:text-slate-300">
                            <p><span class="text-[9px] font-black uppercase text-slate-400 block tracking-widest">Destino</span> {{ deliveryInfo?.address }}, {{ deliveryInfo?.city }}</p>
                            <p><span class="text-[9px] font-black uppercase text-slate-400 block tracking-widest mt-2">Notas</span> {{ deliveryInfo?.notes || 'Sin instrucciones adicionales' }}</p>
                        </div>
                    </div>
                }
            </section>

            <section class="space-y-4">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b-2 border-slate-900 dark:border-slate-700">
                                <th class="py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 w-2/5">Descripción</th>
                                <th class="py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 text-center">Cant</th>
                                <th class="py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 text-right">Precio</th>
                                <th class="py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 text-center">Dcto</th>
                                <th class="py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                            @for (item of items; track item.id) {
                                <tr class="group">
                                    <td class="py-4">
                                        <p class="font-bold text-xs uppercase tracking-tighter dark:text-slate-300">{{ item.name }}</p>
                                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">
                                            {{ (item.reference || '') + (item.extension1 ? ' • ' + item.extension1 : '') }}
                                        </p>
                                    </td>
                                    <td class="py-4 text-center font-bold text-slate-600 dark:text-slate-400 text-xs">{{ item.quantity }}</td>
                                    <td class="py-4 text-right font-medium text-slate-600 dark:text-slate-400 text-xs">{{ item.price | currency: 'COP' : 'symbol' : '1.0-0' }}</td>
                                    <td class="py-4 text-center">
                                        <span [class.opacity-0]="item.discount <= 0" class="bg-rose-100 text-rose-600 text-[9px] font-black px-1.5 py-0.5 rounded italic"> -{{ item.discount }}% </span>
                                    </td>
                                    <td class="py-4 text-right font-black text-slate-800 dark:text-white text-xs">
                                        {{ item.total | currency: 'COP' : 'symbol' : '1.0-0' }}
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-6">
                <div class="space-y-4">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-2">Resumen de Pago</h3>
                    @for (payment of paymentMethods; track $index) {
                        <div class="flex justify-between items-center text-xs">
                            <span class="flex items-center gap-2 font-bold text-slate-500 uppercase tracking-tighter">
                                <i class="pi pi-circle-fill text-[6px] text-emerald-500"></i>
                                {{ getPaymentMethodDetails(payment.type).label }}
                            </span>
                            <span class="font-black text-slate-800 dark:text-white">
                                {{ payment.amount | currency: 'COP' : 'symbol' : '1.0-0' }}
                            </span>
                        </div>
                    }
                </div>

                <div class="bg-slate-900 dark:bg-emerald-950 p-6 rounded-[2rem] text-white space-y-3">
                    <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest opacity-60">
                        <span>Subtotal Bruto</span>
                        <span>{{ grossSubtotal | currency: currencyCode : 'symbol' : '1.0-0' }}</span>
                    </div>
                    <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest text-emerald-400">
                        <span>Descuentos Totales</span>
                        <span>- {{ detailDiscount + ((grossSubtotal - detailDiscount) * (generalDiscount || 0)) / 100 | currency: currencyCode : 'symbol' : '1.0-0' }}</span>
                    </div>
                    <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest opacity-60">
                        <span>Impuestos (IVA)</span>
                        <span>{{ totalVat | currency: currencyCode : 'symbol' : '1.0-0' }}</span>
                    </div>
                    <div class="pt-4 border-t border-slate-700 flex justify-between items-end">
                        <span class="text-xs font-black uppercase tracking-[0.2em]">Total Final</span>
                        <span class="text-3xl font-black tracking-tighter leading-none">{{ total | currency: currencyCode : 'symbol' : '1.0-0' }}</span>
                    </div>
                </div>
            </section>

            <footer class="text-center space-y-2 pt-10">
                <p class="text-[10px] font-black text-slate-800 dark:text-white uppercase tracking-[0.3em]">¡Gracias por su compra!</p>
                <div class="flex flex-col text-[8px] font-bold text-slate-400 uppercase tracking-widest">
                    <span>Esta es una representación gráfica de la factura electrónica</span>
                    <span>Generado por Mi Tienda POS Premium v2.0</span>
                </div>
            </footer>
        </div>
    </div>
</p-dialog>
