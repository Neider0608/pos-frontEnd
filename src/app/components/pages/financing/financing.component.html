<p-toast />

<div class="min-h-screen bg-slate-50 dark:bg-slate-950 p-4 md:p-8 font-sans transition-colors duration-500">
    <div class="max-w-[1600px] mx-auto space-y-8">
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 bg-white dark:bg-slate-900 p-8 rounded-[2rem] shadow-sm border border-slate-200 dark:border-slate-800">
            <div class="flex items-center gap-5">
                <div class="w-14 h-14 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-2xl flex items-center justify-center shadow-inner">
                    <i class="pi pi-wallet text-3xl"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-black text-slate-800 dark:text-slate-100 tracking-tighter uppercase leading-none mb-2">Financiaciones</h2>
                    <div class="flex items-center gap-2">
                        <p class="text-sm text-slate-500 dark:text-slate-400 font-medium italic">Seguimiento de cartera y abonos</p>
                        <span class="px-2 py-0.5 bg-indigo-50 dark:bg-indigo-900/40 text-indigo-600 text-[10px] font-black rounded-md border border-indigo-100 dark:border-indigo-800 uppercase"> Cartera Activa </span>
                    </div>
                </div>
            </div>

            <div class="flex items-center bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700">
                <div class="text-right border-r border-slate-200 dark:border-slate-700 pr-4 mr-4">
                    <p class="text-[10px] uppercase font-black text-slate-400 tracking-widest">Registros</p>
                    <p class="font-black text-xl text-slate-700 dark:text-slate-200 leading-none">{{ filteredFinancings.length }}</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] uppercase font-black text-indigo-500 tracking-widest">Total en Cartera</p>
                    <p class="font-black text-xl text-indigo-600 dark:text-indigo-400 leading-none">Activa</p>
                </div>
            </div>
        </header>

        <section class="bg-white dark:bg-slate-900 p-6 rounded-[2rem] border border-slate-200 dark:border-slate-800 shadow-xl shadow-slate-200/50 dark:shadow-none transition-all">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                <div class="md:col-span-5">
                    <label class="block text-[11px] font-black uppercase tracking-[0.15em] mb-2 text-slate-400 ml-1">Cliente</label>
                    <div class="relative group">
                        <i class="pi pi-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors z-10"></i>
                        <input
                            type="text"
                            pInputText
                            [(ngModel)]="filters.customer"
                            placeholder="Buscar por nombre de cliente..."
                            class="w-full !pl-12 !pr-4 !py-4 !bg-slate-50 dark:!bg-slate-800/50 !border-none !rounded-2xl focus:!ring-2 focus:!ring-indigo-500/20 transition-all dark:text-white font-medium"
                            (input)="applyFilters()"
                        />
                    </div>
                </div>

                <div class="md:col-span-4">
                    <label class="block text-[11px] font-black uppercase tracking-[0.15em] mb-2 text-slate-400 ml-1">Nº Factura</label>
                    <div class="relative group">
                        <i class="pi pi-file absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors z-10"></i>
                        <input
                            type="text"
                            pInputText
                            [(ngModel)]="filters.invoice"
                            placeholder="FAC-000"
                            class="w-full !pl-12 !pr-4 !py-4 !bg-slate-50 dark:!bg-slate-800/50 !border-none !rounded-2xl focus:!ring-2 focus:!ring-indigo-500/20 transition-all dark:text-white font-mono font-bold"
                            (input)="applyFilters()"
                        />
                    </div>
                </div>

                <div class="md:col-span-3 flex gap-3">
                    <button
                        pButton
                        label="Filtrar"
                        icon="pi pi-search"
                        (onClick)="applyFilters()"
                        class="flex-1 !rounded-2xl !py-4 !bg-indigo-600 !border-none !font-black !shadow-lg !shadow-indigo-100 dark:!shadow-none hover:!scale-[1.02] transition-all"
                    ></button>
                    <button pButton icon="pi pi-refresh" (onClick)="resetFilters()" class="!w-14 !h-14 !rounded-2xl p-button-secondary p-button-text !bg-slate-50 dark:!bg-slate-800 hover:!bg-slate-100 transition-all"></button>
                </div>
            </div>
        </section>

        <div class="bg-white dark:bg-slate-900 rounded-[2rem] border border-slate-200 dark:border-slate-800 shadow-2xl shadow-slate-200/50 dark:shadow-none overflow-hidden">
            <p-table [value]="filteredFinancings" [paginator]="true" [rows]="8" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr class="!bg-slate-50 dark:!bg-slate-800/50">
                        <th pSortableColumn="customerName" class="!py-6 !px-8 text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest bg-transparent">Cliente <p-sortIcon field="customerName"></p-sortIcon></th>
                        <th class="!py-6 !px-8 text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest bg-transparent text-center">Factura</th>
                        <th class="!py-6 !px-8 text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest bg-transparent text-right">Financiado</th>
                        <th class="!py-6 !px-8 text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest bg-transparent text-right">Saldo Actual</th>
                        <th class="!py-6 !px-8 text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest bg-transparent text-center">Estado</th>
                        <th class="!py-6 !px-8 bg-transparent text-center w-32">Gestión</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-row>
                    <tr class="border-b border-slate-50 dark:border-slate-800/50 last:border-none hover:bg-indigo-50/20 transition-all group">
                        <td class="px-8 py-5">
                            <span class="font-bold text-slate-800 dark:text-slate-200 text-base tracking-tight">{{ row.customerName }}</span>
                        </td>
                        <td class="px-8 py-5 text-center">
                            <span class="bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-3 py-1.5 rounded-xl font-mono text-xs font-bold border border-slate-200 dark:border-slate-700">
                                {{ row.invoiceNumber }}
                            </span>
                        </td>
                        <td class="px-8 py-5 text-right font-bold text-slate-600 dark:text-slate-400 italic">
                            {{ row.totalFinanced | currency: 'COP' : 'symbol' : '1.0-0' : 'es-CO' }}
                        </td>
                        <td class="px-8 py-5 text-right font-mono font-black text-lg">
                            <span [ngClass]="row.currentBalance > 0 ? 'text-indigo-600 dark:text-indigo-400' : 'text-emerald-500'">
                                {{ row.currentBalance | currency: 'COP' : 'symbol' : '1.0-0' : 'es-CO' }}
                            </span>
                        </td>
                        <td class="px-8 py-5 text-center">
                            <span
                                [ngClass]="
                                    row.currentBalance > 0
                                        ? 'bg-amber-50 text-amber-600 border-amber-100 dark:bg-amber-900/20 dark:text-amber-400 dark:border-amber-800'
                                        : 'bg-emerald-50 text-emerald-600 border-emerald-100 dark:bg-emerald-900/20 dark:text-emerald-400 dark:border-emerald-800'
                                "
                                class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest border"
                            >
                                {{ row.currentBalance > 0 ? 'Pendiente' : 'Pagado' }}
                            </span>
                        </td>
                        <td class="px-8 py-5">
                            <div class="flex gap-2 justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <button (click)="viewPayments(row)" class="w-10 h-10 rounded-xl flex items-center justify-center text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-all" pTooltip="Ver Historial">
                                    <i class="pi pi-eye"></i>
                                </button>
                                <button
                                    (click)="openPaymentDialog(row)"
                                    *ngIf="canView"
                                    [disabled]="row.currentBalance === 0"
                                    class="w-10 h-10 rounded-xl flex items-center justify-center text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 transition-all disabled:opacity-30"
                                    pTooltip="Nuevo Abono"
                                >
                                    <i class="pi pi-plus-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>

    <p-dialog [(visible)]="showPaymentsDialog" [modal]="true" [draggable]="false" [resizable]="false" styleClass="!rounded-[2.5rem] !border-none !bg-white dark:!bg-slate-900 overflow-hidden shadow-3xl" [style]="{ width: '850px' }">
        <ng-template pTemplate="header">
            <div class="flex items-center gap-4 pt-4">
                <div class="w-12 h-12 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center text-indigo-600">
                    <i class="pi pi-history text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-black tracking-tighter text-slate-800 dark:text-slate-100 uppercase">Línea de Pago</h3>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]" *ngIf="selectedFinancing">{{ selectedFinancing.customerName }}</p>
                </div>
            </div>
        </ng-template>

        <div class="space-y-8 p-4">
            <div class="grid grid-cols-2 gap-4 bg-slate-900 dark:bg-indigo-950 p-8 rounded-[2rem] text-white">
                <div>
                    <p class="text-white/40 text-[10px] uppercase font-black tracking-widest mb-1">Referencia Factura</p>
                    <p class="text-2xl font-black">#{{ selectedFinancing?.invoiceNumber }}</p>
                </div>
                <div class="text-right">
                    <p class="text-white/40 text-[10px] uppercase font-black tracking-widest mb-1">Saldo Remanente</p>
                    <p class="text-3xl font-black text-indigo-400">
                        {{ selectedFinancing?.currentBalance | currency: 'COP' : 'symbol' : '1.0-0' : 'es-CO' }}
                    </p>
                </div>
            </div>

            <p-table [value]="financingPayments" [rows]="5" [paginator]="true" styleClass="p-datatable-flush">
                <ng-template pTemplate="header">
                    <tr class="text-slate-400 border-b border-slate-100 dark:border-slate-800">
                        <th class="py-4 text-[10px] font-black tracking-widest uppercase bg-transparent text-center">Fecha</th>
                        <th class="py-4 text-[10px] font-black tracking-widest uppercase bg-transparent">Método</th>
                        <th class="py-4 text-right text-[10px] font-black tracking-widest uppercase bg-transparent">Monto</th>
                        <th class="py-4 text-center bg-transparent">PDF</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-payment>
                    <tr class="border-b border-slate-50 dark:border-slate-800/50">
                        <td class="py-5 text-center font-medium text-slate-600 dark:text-slate-400 text-sm">{{ payment.paymentDate | date: 'short' }}</td>
                        <td class="py-5">
                            <span class="bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-lg text-[10px] font-black text-slate-500 uppercase">
                                {{ getPaymentLabel(payment.paymentMethod) }}
                            </span>
                        </td>
                        <td class="py-5 text-right font-black text-slate-800 dark:text-slate-200">
                            {{ payment.paymentAmount | currency: 'COP' : 'symbol' : '1.0-0' : 'es-CO' }}
                        </td>
                        <td class="py-5 text-center">
                            <button (click)="generateReceipt(payment)" class="w-10 h-10 rounded-xl text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/30 transition-all">
                                <i class="pi pi-file-pdf text-lg"></i>
                            </button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-between items-center pb-8 pt-4 px-4 w-full">
                <button
                    pButton
                    label="Paz y Salvo"
                    icon="pi pi-verified"
                    (click)="generateClearance()"
                    *ngIf="selectedFinancing?.currentBalance === 0"
                    class="!rounded-2xl !py-3 !px-6 !bg-emerald-600 !border-none !font-bold shadow-lg shadow-emerald-100"
                ></button>
                <div class="flex-grow"></div>
                <button pButton label="Cerrar Panel" (click)="showPaymentsDialog = false" class="p-button-text !text-slate-400 !font-bold"></button>
            </div>
        </ng-template>
    </p-dialog>

    <p-dialog header="Registrar Abono" [(visible)]="showPaymentDialog" [modal]="true" [draggable]="false" styleClass="!rounded-[2.5rem] !border-none !bg-white dark:!bg-slate-950 overflow-hidden shadow-3xl" [style]="{ width: '450px' }">
        <div class="space-y-8 pt-6 px-4">
            <div class="bg-indigo-50 dark:bg-indigo-900/20 p-8 rounded-[2rem] border-2 border-dashed border-indigo-200 dark:border-indigo-800 text-center group transition-all">
                <label class="block text-[10px] font-black uppercase tracking-[0.3em] text-indigo-500 mb-3">Monto a Recibir</label>
                <p-inputNumber
                    [(ngModel)]="newPayment.amount"
                    mode="currency"
                    currency="COP"
                    locale="es-CO"
                    inputStyleClass="w-full text-4xl font-black bg-transparent border-none p-0 text-center focus:ring-0 text-indigo-800 dark:text-indigo-400"
                    placeholder="$ 0.00"
                >
                </p-inputNumber>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <div>
                    <label class="block text-[11px] font-black uppercase tracking-widest text-slate-400 mb-3 ml-1">Medio de Captura</label>
                    <p-dropdown [options]="paymentMethods" [(ngModel)]="newPayment.method" appendTo="body" placeholder="Seleccione método..." styleClass="w-full !bg-slate-50 dark:!bg-slate-800/50 !border-none !rounded-2xl !py-2 !px-3 shadow-inner">
                    </p-dropdown>
                </div>

                <div>
                    <label class="block text-[11px] font-black uppercase tracking-widest text-slate-400 mb-3 ml-1">Observaciones</label>
                    <textarea
                        [(ngModel)]="newPayment.notes"
                        rows="3"
                        class="w-full !bg-slate-50 dark:!bg-slate-800/50 !border-none !rounded-2xl p-4 text-sm focus:!ring-2 focus:!ring-indigo-500/20 transition-all dark:text-white"
                        placeholder="Nota interna del movimiento..."
                    ></textarea>
                </div>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="grid grid-cols-2 gap-4 w-full pb-8 pt-4 px-4">
                <button pButton label="Cancelar" (click)="showPaymentDialog = false" class="p-button-text !text-slate-400 !font-bold !py-4"></button>
                <button
                    pButton
                    label="Confirmar Abono"
                    icon="pi pi-check-circle"
                    (click)="savePayment()"
                    [disabled]="!newPayment.amount || !newPayment.method"
                    class="!rounded-2xl !py-4 !bg-indigo-600 !border-none !font-black !shadow-xl !shadow-indigo-100"
                ></button>
            </div>
        </ng-template>
    </p-dialog>
</div>
